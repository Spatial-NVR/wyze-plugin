name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUM=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Download wyzecam library
        run: |
          WYZECAM_VERSION="2.10.2"
          curl -sL "https://github.com/mrlt8/docker-wyze-bridge/archive/refs/tags/v${WYZECAM_VERSION}.tar.gz" | tar -xz
          cp -r "docker-wyze-bridge-${WYZECAM_VERSION}/app/wyzecam" .
          rm -rf "docker-wyze-bridge-${WYZECAM_VERSION}"

      - name: Prepare release package
        run: |
          mkdir -p release pkg

          # Update version in manifest
          sed -i "s/version:.*/version: ${{ steps.version.outputs.VERSION_NUM }}/" manifest.yaml

          # Copy plugin files
          cp wyze_plugin.py pkg/
          cp manifest.yaml pkg/
          cp requirements.txt pkg/
          cp setup.sh pkg/
          cp -r wyzecam pkg/

          # Create tarball
          tar -czf "release/wyze-plugin-${{ steps.version.outputs.VERSION }}.tar.gz" -C pkg .

          ls -la release/

      - name: Generate changelog
        run: |
          cat > CHANGELOG.md << 'EOF'
          ## Wyze Plugin ${{ steps.version.outputs.VERSION }}

          ### Changes
          - Python-based plugin using wyzecam library directly (like Scrypted)
          - Direct TUTK P2P camera connections
          - No external dependencies (MediaMTX, wyze-bridge subprocess)
          - Downloads TUTK library automatically

          ### Supported Devices
          - Wyze Cam v2/v3
          - Wyze Cam Pan v1/v2
          - Wyze Cam Outdoor
          - Other TUTK-compatible Wyze cameras
          EOF

      - name: Create tag (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.VERSION }}" -m "Release ${{ steps.version.outputs.VERSION }}"
          git push origin "${{ steps.version.outputs.VERSION }}"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Wyze Plugin ${{ steps.version.outputs.VERSION }}"
          tag_name: ${{ steps.version.outputs.VERSION }}
          body_path: CHANGELOG.md
          files: release/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
